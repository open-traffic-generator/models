name: Models CI/CD

# Trigger everytime a push occurs
on:
  push:
    paths:
    - '!artifacts/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          # Fetches entire history, so we can analyze all existing tags
          fetch-depth: 0

      - name: Build container image
        run: docker build . -t models || exit 1

      - name: Generate artifacts
        id: gen_artifact
        # 1. Mount local dir to a dir inside container where build artifacts are
        #    generated so that we don't have to actually get inside the container.
        # 2. 'artifacts/tag' file containing version number is generated if there's
        #    no tag for current API version.
        # 3. Set 'tag' variable to '0' if 'artifacts/tag' is not generated (i.e.
        #    tag for that version already exists), otherwise store version.
        #    This will be used later to indicate whether we need to create new tag/release or not.
        run: |
          mkdir -p artifacts
          docker run -v $(pwd)/artifacts:/home/otg/models/artifacts/ models /bin/bash -c "./do.sh art" || exit 1
          echo "::set-output name=tag::$(cat artifacts/tag || echo 0)"

      - name: Commit auto generated content
        id: commit_artifact
        # https://github.com/stefanzweifel/git-auto-commit-action
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Update autogenerated artifacts
          file_pattern: artifacts/openapi.yaml artifacts/openapi.json artifacts/protobuf3.tar.gz
          commit_options: '--no-verify --signoff'       

